<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Pages - Arcator</title>
    <link href="./master.css" rel="stylesheet">
    <link href="./favicon.png" rel="icon" type="image/png">
</head>
<body class="bg-surface text-text">
<div id="navbar-placeholder"></div>

<section class="hero-banner">
    <img alt="Hero" class="hero-image" src="./creativespawn.png">
    <div class="hero-overlay"></div>
    <div class="hero-content">
        <h1>Pages</h1>
        <p>Custom community pages</p>
    </div>
</section>

<main class="container mx-auto px-4 py-8" style="padding-bottom: calc(var(--footer-height) + 1rem); flex: 1 0 auto;">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="pages-list">
        <div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--color-text-2);">Loading pages...</div>
    </div>
</main>

<div id="footer-placeholder"></div>
<script type="module">
    import {db, COLLECTIONS} from './firebase-init.js';
    import {initializePage, loadFooter} from './core.js';
    import {showMessageBox} from './utils.js';
    import {themeManager} from './theme-manager.js';
    import {collection, getDocs, query, orderBy} from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

    async function loadPages() {
        const pagesList = document.getElementById('pages-list');
        try {
            const pagesRef = collection(db, COLLECTIONS.PAGES);
            const pagesQuery = query(pagesRef, orderBy('createdAt', 'desc'));
            const snapshot = await getDocs(pagesQuery);

            if (snapshot.empty) {
                pagesList.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--color-text-2);">No pages found</div>';
                return;
            }

            pagesList.innerHTML = snapshot.docs.map(doc => {
                const page = doc.data();
                let createdDate = 'Unknown';
                if (page.createdAt) {
                    try {
                        if (typeof page.createdAt === 'object' && page.createdAt.seconds) {
                            createdDate = new Date(page.createdAt.seconds * 1000).toLocaleDateString();
                        } else if (typeof page.createdAt.toDate === 'function') {
                            createdDate = page.createdAt.toDate().toLocaleDateString();
                        } else if (page.createdAt instanceof Date) {
                            createdDate = page.createdAt.toLocaleDateString();
                        } else if (typeof page.createdAt === 'number') {
                            createdDate = new Date(page.createdAt).toLocaleDateString();
                        }
                    } catch (e) {
                        console.warn('Date conversion error:', e);
                    }
                }
                return `<div style="background:var(--color-surface-2);border:1px solid var(--color-accent-dark);border-radius:0.375rem;padding:1.5rem;">
                    <h3 style="margin-top:0;font-size:1.125rem;font-weight:600;">${page.title || 'Untitled'}</h3>
                    <p style="color:var(--color-text-2);margin:0.5rem 0;">${page.description || 'No description'}</p>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;">
                        <span style="font-size:0.875rem;color:var(--color-text-2);">Created: ${createdDate}</span>
                        <a href="./page.html?id=${doc.id}" class="btn-primary" style="font-size:0.875rem;">View</a>
                    </div>
                </div>`;
            }).join('');
        } catch (error) {
            console.error('Load pages error:', error);
            pagesList.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--color-error);padding:2rem;">Failed to load pages: ${error.message}</div>`;
        }
    }

    async function init() {
        try {
            await Promise.all([initializePage('pages'), themeManager.init()]);
            await loadPages();
            await loadFooter();
            console.log('Pages initialized');
        } catch (error) {
            console.error('Pages init error:', error);
            showMessageBox(`Error: ${error.message}`, true);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
</script>
</body>
</html>