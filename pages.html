<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Pages - Arcator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="./styles.css" rel="stylesheet">
    <link href="./favicon.png" rel="icon" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
</head>
<body>
    <div id="navbar-placeholder"></div>

    <div x-data="pagesData" class="d-flex w-100">
        <!-- Mobile Sidebar Toggle -->
        <button class="btn btn-primary d-md-none position-fixed bottom-0 end-0 m-3 z-3 rounded-circle p-3 shadow" 
                @click="showSidebar = !showSidebar" title="Toggle Sidebar" aria-label="Toggle Sidebar">
            <i class="bi" :class="showSidebar ? 'bi-x-lg' : 'bi-list'"></i>
        </button>

        <!-- Sidebar -->
        <div class="sidebar p-3" :class="showSidebar ? 'show' : ''">
            <div>
                <div class="d-flex justify-content-between align-items-center mb-4 px-2">
                    <h4 class="text-light m-0 d-flex align-items-center gap-2">
                        <i class="bi bi-book"></i> Pages
                    </h4>
                    <button class="btn btn-sm btn-outline-light" @click="createPage" x-show="currentUser" title="New Page">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="nav flex-column nav-pills gap-2">
                    <template x-for="page in pages" :key="page.id">
                        <a :href="'?id=' + page.id" 
                           class="nav-link nav-link-custom" 
                           :class="currentPageId === page.id ? 'active' : ''"
                           @click="showSidebar = false">
                            <i class="bi bi-file-text"></i>
                            <span x-text="page.title || 'Untitled'"></span>
                        </a>
                    </template>
                    <div x-show="!loading && pages.length === 0" class="text-muted small px-2">No pages found</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content w-100">
            <template x-if="loading">
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="spinner-border text-primary"></div>
                </div>
            </template>

            <template x-if="!loading && !currentPageId">
                <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted" style="min-height: 60vh;">
                    <i class="bi bi-file-text display-1 mb-3 opacity-50"></i>
                    <h3>Select a page to view</h3>
                    <p>Choose a document from the sidebar to get started.</p>
                </div>
            </template>

            <template x-if="!loading && currentPageId && !currentPage">
                <div class="d-flex flex-column justify-content-center align-items-center h-100 text-danger" style="min-height: 60vh;">
                    <i class="bi bi-exclamation-circle display-1 mb-3"></i>
                    <h3>Page not found</h3>
                    <a href="./pages.html" class="btn btn-outline-light mt-3">Return to Index</a>
                </div>
            </template>

            <template x-if="!loading && currentPage">
                <div class="container-fluid">
                <div class="glass-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="display-5 fw-bold mb-1" x-text="currentPage?.title"></h1>
                            <div class="text-muted small d-flex align-items-center gap-2">
                                <span x-text="formatDate(currentPage?.createdAt)"></span>
                                <span>â€¢</span>
                                <span>By <span x-text="authorName"></span></span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-secondary font-monospace" x-text="currentPage?.slug ? '/' + currentPage.slug : ''"></span>
                            <button class="btn btn-outline-light btn-sm" @click="editPage" x-show="canEdit" title="Edit Page">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    </div>
                    
                    <p class="lead text-secondary" x-text="currentPage?.description"></p>
                    
                    <hr class="border-secondary opacity-25 my-4">
                    
                    <div class="page-content" x-html="renderContent(currentPage?.content)"></div>
                    
                    <div class="mt-5 pt-3 border-top border-secondary border-opacity-25 text-muted small">
                        Last updated: <span x-text="formatDate(currentPage?.updatedAt)"></span>
                    </div>
                </div>
            </div>
            </template>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script type="module" src="./app.js"></script>
    <script type="module">
        import { db, COLLECTIONS, collection, getDocs, getDoc, doc, query, orderBy, formatDate, addDoc, updateDoc, serverTimestamp, deleteDoc } from './app.js';

        document.addEventListener('alpine:init', () => {
            Alpine.data('pagesData', () => ({
                pages: [],
                currentPage: null,
                currentPageId: new URL(location.href).searchParams.get('id'),
                loading: true,
                authorName: 'Unknown',
                showSidebar: false,
                get currentUser() { return Alpine.store('auth')?.user; },
                get isAdmin() { return Alpine.store('auth')?.isAdmin; },
                get canEdit() {
                    if (!this.currentUser || !this.currentPage) return false;
                    if (this.isAdmin) return true;
                    if (this.currentPage.authorId === this.currentUser.uid) return true;
                    return false;
                },

                async init() {
                    await this.loadPagesList();
                    if (this.currentPageId) {
                        await this.loadSinglePage(this.currentPageId);
                    }
                },

                async loadPagesList() {
                    try {
                        const q = query(collection(db, COLLECTIONS.PAGES), orderBy('createdAt', 'desc'));
                        const snap = await getDocs(q);
                        this.pages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    } catch (e) {
                        console.error(e);
                    } finally {
                        if (!this.currentPageId) this.loading = false;
                    }
                },

                async loadSinglePage(id) {
                    try {
                        const snap = await getDoc(doc(db, COLLECTIONS.PAGES, id));
                        if (snap.exists()) {
                            this.currentPage = { id: snap.id, ...snap.data() };
                            document.title = `${this.currentPage.title || 'Page'} - Arcator`;
                            await this.loadAuthor(this.currentPage.createdBy || this.currentPage.authorId);
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        this.loading = false;
                    }
                },

                async loadAuthor(uid) {
                    if (!uid) return;
                    try {
                        const snap = await getDoc(doc(db, COLLECTIONS.USER_PROFILES, uid));
                        if (snap.exists()) {
                            this.authorName = snap.data().displayName || snap.data().email || 'Unknown';
                        } else {
                            this.authorName = uid;
                        }
                    } catch (e) {
                        this.authorName = uid;
                    }
                },

                formatDate(ts) {
                    if (!ts) return '';
                    const d = ts.seconds ? new Date(ts.seconds * 1000) : new Date(ts);
                    return dayjs(d).format('MMMM D, YYYY [at] h:mm A');
                },

                renderContent(content) {
                    if (!content) return '';
                    const isHtml = /<[a-z][\s\S]*>/i.test(content);
                    return DOMPurify.sanitize(isHtml ? content : marked.parse(content));
                },

                async createPage() {
                    if (!this.currentUser) return Swal.fire('Error', 'You must be logged in.', 'error');
                    
                    const { value } = await Swal.fire({
                        title: 'New Page',
                        width: '800px',
                        html: `
                            <input id="np-title" class="form-control mb-2" placeholder="Title">
                            <input id="np-slug" class="form-control mb-2" placeholder="Slug (optional)">
                            <input id="np-desc" class="form-control mb-2" placeholder="Description">
                            <input id="np-tags" class="form-control mb-2" placeholder="Tags (comma separated, e.g. wiki, help)">
                            <div id="editor-container" style="height: 300px; background: white; color: black;"></div>
                        `,
                        didOpen: () => {
                            this.quill = new Quill('#editor-container', { theme: 'snow' });
                        },
                        showCancelButton: true,
                        preConfirm: () => ({
                            title: document.getElementById('np-title').value,
                            slug: document.getElementById('np-slug').value,
                            description: document.getElementById('np-desc').value,
                            tags: document.getElementById('np-tags').value.split(',').map(t => t.trim()).filter(t => t),
                            content: this.quill.root.innerHTML
                        })
                    });

                    if (value) {
                        if (!value.title) return Swal.fire('Error', 'Title is required', 'error');
                        try {
                            const docRef = await addDoc(collection(db, COLLECTIONS.PAGES), {
                                ...value,
                                authorId: this.currentUser.uid,
                                createdBy: this.currentUser.uid,
                                createdAt: serverTimestamp(),
                                updatedAt: serverTimestamp()
                            });
                            await this.loadPagesList();
                            window.location.href = `?id=${docRef.id}`;
                        } catch (e) {
                            console.error(e);
                            Swal.fire('Error', 'Failed to create page', 'error');
                        }
                    }
                },

                async editPage() {
                    if (!this.currentPage) return;
                    
                    const { value } = await Swal.fire({
                        title: 'Edit Page',
                        width: '800px',
                        html: `
                            <input id="ep-title" class="form-control mb-2" placeholder="Title" value="${this.currentPage.title || ''}">
                            <input id="ep-slug" class="form-control mb-2" placeholder="Slug" value="${this.currentPage.slug || ''}">
                            <input id="ep-desc" class="form-control mb-2" placeholder="Description" value="${this.currentPage.description || ''}">
                            <input id="ep-tags" class="form-control mb-2" placeholder="Tags" value="${(this.currentPage.tags || []).join(', ')}">
                            <div id="editor-container" style="height: 300px; background: white; color: black;"></div>
                        `,
                        didOpen: () => {
                            this.quill = new Quill('#editor-container', { theme: 'snow' });
                            this.quill.root.innerHTML = this.currentPage.content || '';
                        },
                        showCancelButton: true,
                        preConfirm: () => ({
                            title: document.getElementById('ep-title').value,
                            slug: document.getElementById('ep-slug').value,
                            description: document.getElementById('ep-desc').value,
                            tags: document.getElementById('ep-tags').value.split(',').map(t => t.trim()).filter(t => t),
                            content: this.quill.root.innerHTML
                        })
                    });

                    if (value) {
                        try {
                            await updateDoc(doc(db, COLLECTIONS.PAGES, this.currentPage.id), {
                                ...value,
                                updatedAt: serverTimestamp()
                            });
                            await this.loadSinglePage(this.currentPage.id);
                            await this.loadPagesList(); // Refresh sidebar title if changed
                            Swal.fire('Success', 'Page updated', 'success');
                        } catch (e) {
                            console.error(e);
                            Swal.fire('Error', 'Failed to update page', 'error');
                        }
                    }
                }
            }));
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
</body>
</html>
