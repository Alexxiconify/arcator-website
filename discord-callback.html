<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Callback - Arcator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-dark text-light d-flex align-items-center justify-content-center vh-100">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h4>Linking Discord...</h4>
        <p class="text-muted">Please wait while we complete the connection.</p>
    </div>

    <script type="module">
        import { auth, db, COLLECTIONS, updateDoc, doc, onAuthStateChanged } from './firebase-init.js';
        
        async function handleCallback() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            const state = params.get('state');
            const savedState = sessionStorage.getItem('discord_oauth_state');
            
            if (!accessToken || state !== savedState) {
                await Swal.fire('Error', 'Invalid OAuth state or token', 'error');
                window.location.href = './users.html';
                return;
            }
            
            // Wait for auth to be ready
            const user = await new Promise(resolve => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    unsubscribe();
                    resolve(u);
                });
            });
            
            if (!user) {
                await Swal.fire('Error', 'You must be logged in to link Discord', 'error');
                window.location.href = './users.html';
                return;
            }

            try {
                // Fetch user info from Discord API officially
                const userResponse = await fetch('https://discord.com/api/users/@me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const userData = await userResponse.json();

                if (!userData.id) throw new Error('Failed to fetch Discord user data');

                const avatarUrl = userData.avatar 
                    ? `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`
                    : './defaultuser.png';

                await updateDoc(doc(db, COLLECTIONS.USER_PROFILES, user.uid), {
                    discordLinked: true,
                    discordId: userData.id,
                    discordTag: `${userData.username}${userData.discriminator !== '0' ? '#' + userData.discriminator : ''}`,
                    discordPic: avatarUrl,
                    lastDiscordLink: new Date().toISOString()
                });

                await Swal.fire({
                    title: 'Discord Linked!',
                    text: `Successfully connected as ${userData.username}. Your profile picture and ID have been updated.`,
                    icon: 'success',
                    timer: 3000,
                    showConfirmButton: false
                });
                
                window.location.href = './users.html';
            } catch (e) {
                await Swal.fire('Error', e.message, 'error');
                window.location.href = './users.html';
            }
        }
        
        handleCallback();
    </script>
</body>
</html>
