<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Admin - Arcator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="./styles.css" rel="stylesheet">
    <link href="./favicon.png" rel="icon" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<div id="navbar-placeholder"></div>

<div x-data="adminData">
    <div x-show="loading" class="container py-5 text-center"><div class="spinner-border text-primary"></div></div>

    <div x-show="!loading && !isAdmin" class="container py-5 text-center">
        <div class="alert alert-warning">You must be an admin to access this page.</div>
        <a href="./users.html" class="btn btn-primary">Sign In</a>
    </div>

    <div x-show="!loading && isAdmin">
        <section class="hero-section">
            <img src="./creativespawn.png" alt="Hero" loading="lazy">
            <div class="hero-overlay"></div>
            <div class="hero-content">
                <h1 class="display-4 fw-bold mb-3">Admin Panel</h1>
                <p class="lead">Manage users, pages, and forums</p>
            </div>
        </section>

        <main class="container py-5">
            <div class="row g-4">
                <!-- Users -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Users</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush admin-list-scroll">
                                <template x-for="user in users" :key="user.id">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center gap-2">
                                            <img :src="user.photoURL || './defaultuser.png'" class="profile-img-sm" alt="Profile">
                                            <span x-text="user.displayName || user.email || 'Unknown'"></span>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" @click="editUser(user)">Edit</button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pages -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Pages</h5>
                            <button class="btn btn-primary btn-sm" @click="createPage">New Page</button>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush admin-list-scroll">
                                <template x-for="page in pages" :key="page.id">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span x-text="page.title || 'Untitled'"></span>
                                        <div class="btn-group btn-group-sm">
                                            <a :href="'./pages.html?id=' + page.id" class="btn btn-outline-secondary">View</a>
                                            <button class="btn btn-outline-primary" @click="editPage(page)">Edit</button>
                                            <button class="btn btn-outline-danger" @click="deletePage(page.id)">Delete</button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Threads -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Forum Threads</h5></div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead><tr><th>Title</th><th>Author</th><th>Category</th><th>Date</th><th>Actions</th></tr></thead>
                                    <tbody>
                                        <template x-for="thread in threads" :key="thread.id">
                                            <tr>
                                                <td x-text="thread.title || 'Untitled'"></td>
                                                <td x-text="getAuthorName(thread.authorId)"></td>
                                                <td x-text="thread.category || 'General'"></td>
                                                <td x-text="formatDate(thread.createdAt)"></td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-secondary" @click="viewThread(thread)">View</button>
                                                        <button class="btn btn-outline-primary" @click="editThread(thread)">Edit</button>
                                                        <button class="btn btn-outline-danger" @click="deleteThread(thread.id)">Delete</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DMs -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Direct Messages</h5></div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead><tr><th>Name</th><th>Participants</th><th>Last Message</th><th>Date</th><th>Actions</th></tr></thead>
                                    <tbody>
                                        <template x-for="dm in dms" :key="dm.id">
                                            <tr>
                                                <td x-text="getDMName(dm)"></td>
                                                <td x-text="dm.participants.map(uid => getAuthorName(uid)).join(', ')"></td>
                                                <td x-text="dm.lastMessage || ''"></td>
                                                <td x-text="formatDate(dm.lastMessageTime)"></td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" @click="viewDM(dm)">View</button>
                                                        <button class="btn btn-outline-danger" @click="deleteDM(dm.id)">Delete</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<div id="footer-placeholder"></div>

<script type="module" src="./app.js"></script>
<script type="module">
    import { db, COLLECTIONS, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, limit } from './firebase-init.js';
    import { formatDate } from './helpers.js';

    document.addEventListener('alpine:init', () => {
        Alpine.data('adminData', () => ({
            users: [],
            pages: [],
            threads: [],
            posts: [],
            dms: [],
            loading: true,
            isAdmin: false,

            async init() {
                Alpine.effect(async () => {
                    const store = Alpine.store('auth');
                    if (!store.loading) {
                        if (store.user) {
                            this.isAdmin = await store.checkAdmin(store.user.uid);
                            if (this.isAdmin) await this.refreshAll();
                        } else {
                            this.isAdmin = false;
                        }
                        this.loading = false;
                    }
                });
            },

            async refreshAll() {
                try {
                    const results = await Promise.allSettled([
                        getDocs(collection(db, COLLECTIONS.USER_PROFILES)),
                        getDocs(collection(db, COLLECTIONS.PAGES)),
                        getDocs(query(collection(db, COLLECTIONS.FORMS), orderBy('createdAt', 'desc'))),
                        getDocs(query(collection(db, COLLECTIONS.CONVERSATIONS), orderBy('lastMessageTime', 'desc')))
                    ]);

                    // Users
                    if (results[0].status === 'fulfilled') {
                        this.users = results[0].value.docs.map(d => ({ id: d.id, ...d.data() }));
                    } else {
                        console.error('Failed to fetch users:', results[0].reason);
                    }

                    // Pages
                    if (results[1].status === 'fulfilled') {
                        this.pages = results[1].value.docs.map(d => ({ id: d.id, ...d.data() }));
                    } else {
                        console.error('Failed to fetch pages:', results[1].reason);
                    }

                    // Threads
                    if (results[2].status === 'fulfilled') {
                        this.threads = results[2].value.docs.map(d => ({ id: d.id, ...d.data() }));
                    } else {
                        console.error('Failed to fetch threads:', results[2].reason);
                        // Fallback
                        try {
                            const snap = await getDocs(collection(db, COLLECTIONS.FORMS));
                            this.threads = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        } catch (e) { console.error('Fallback threads failed:', e); }
                    }

                    // DMs
                    if (results[3].status === 'fulfilled') {
                        this.dms = results[3].value.docs.map(d => ({ id: d.id, ...d.data() }));
                    } else {
                        console.error('Failed to fetch DMs:', results[3].reason);
                        // Fallback
                        try {
                            const snap = await getDocs(collection(db, COLLECTIONS.CONVERSATIONS));
                            this.dms = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        } catch (e) { console.error('Fallback DMs failed:', e); }
                    }
                } catch (e) {
                    console.error('Error refreshing admin data:', e);
                }
            },

            getAuthorName(uid) {
                const user = this.users.find(u => u.id === uid);
                return user ? (user.displayName || user.email) : 'Unknown';
            },

            getDMName(dm) {
                if (dm.name && dm.name !== 'Chat') return dm.name;
                const names = dm.participants.map(uid => this.getAuthorName(uid)).join(', ');
                return names || 'Chat';
            },

            formatDate(ts) { return formatDate(ts); },

            async createPage() {
                const { value } = await Swal.fire({
                    title: 'Create Page',
                    html: '<input id="new-page-title" class="form-control mb-2" placeholder="Title"><input id="new-page-slug" class="form-control mb-2" placeholder="Slug"><textarea id="new-page-content" class="form-control" rows="10" placeholder="Content"></textarea>',
                    showCancelButton: true,
                    preConfirm: () => ({
                        title: document.getElementById('new-page-title').value,
                        slug: document.getElementById('new-page-slug').value,
                        content: document.getElementById('new-page-content').value,
                        createdAt: new Date()
                    })
                });
                if (value) {
                    await addDoc(collection(db, COLLECTIONS.PAGES), value);
                    await this.refreshAll();
                    Swal.fire('Created', '', 'success');
                }
            },

            async editPage(page) {
                const { value } = await Swal.fire({
                    title: 'Edit Page',
                    html: `<input id="ed-page-title" class="form-control mb-2" placeholder="Title" value="${page.title || ''}"><input id="ed-page-slug" class="form-control mb-2" placeholder="Slug" value="${page.slug || ''}"><textarea id="ed-page-content" class="form-control" rows="10">${page.content || ''}</textarea>`,
                    showCancelButton: true,
                    preConfirm: () => ({
                        title: document.getElementById('ed-page-title').value,
                        slug: document.getElementById('ed-page-slug').value,
                        content: document.getElementById('ed-page-content').value
                    })
                });
                if (value) {
                    await updateDoc(doc(db, COLLECTIONS.PAGES, page.id), value);
                    await this.refreshAll();
                    Swal.fire('Updated', '', 'success');
                }
            },

            async deletePage(id) {
                if (confirm('Delete this page?')) {
                    await deleteDoc(doc(db, COLLECTIONS.PAGES, id));
                    await this.refreshAll();
                }
            },

            async editThread(thread) {
                const { value } = await Swal.fire({
                    title: 'Edit Thread',
                    html: `<input id="ed-thread-title" class="form-control mb-2" value="${thread.title || ''}"><select id="ed-thread-category" class="form-select mb-2"><option value="General" ${thread.category === 'General' ? 'selected' : ''}>General</option><option value="Announcements" ${thread.category === 'Announcements' ? 'selected' : ''}>Announcements</option><option value="Support" ${thread.category === 'Support' ? 'selected' : ''}>Support</option></select><textarea id="ed-thread-content" class="form-control" rows="10">${thread.description || ''}</textarea>`,
                    showCancelButton: true,
                    preConfirm: () => ({
                        title: document.getElementById('ed-thread-title').value,
                        category: document.getElementById('ed-thread-category').value,
                        description: document.getElementById('ed-thread-content').value
                    })
                });
                if (value) {
                    await updateDoc(doc(db, COLLECTIONS.FORMS, thread.id), value);
                    await this.refreshAll();
                    Swal.fire('Updated', '', 'success');
                }
            },

            async deleteThread(id) {
                if (confirm('Delete this thread?')) {
                    await deleteDoc(doc(db, COLLECTIONS.FORMS, id));
                    await this.refreshAll();
                }
            },

            async viewThread(thread) {
                const snap = await getDocs(query(collection(db, COLLECTIONS.SUBMISSIONS(thread.id)), orderBy('createdAt', 'asc')));
                const comments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const commentsHtml = comments.map(c => `
                    <div class="mb-2 border-bottom pb-1">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">${this.getAuthorName(c.authorId)} (${formatDate(c.createdAt)}):</small>
                            <button class="btn btn-link btn-sm p-0 text-danger" onclick="window.deleteThreadComment('${thread.id}', '${c.id}')">Delete</button>
                        </div>
                        <div>${c.content}</div>
                    </div>
                `).join('');

                window.deleteThreadComment = async (threadId, commentId) => {
                    if(confirm('Delete comment?')) {
                        await deleteDoc(doc(db, COLLECTIONS.SUBMISSIONS(threadId), commentId));
                        Swal.close();
                        this.viewThread(thread); // Refresh
                    }
                };

                Swal.fire({
                    title: thread.title,
                    html: `<div class="text-start mb-3 p-2 bg-dark rounded">${thread.description}</div>
                           <h6 class="text-start">Comments</h6>
                           <div style="max-height: 400px; overflow-y: auto; text-align: left;">${commentsHtml || 'No comments'}</div>`,
                    width: 800
                });
            },
            
            async editPost(post) {
                const { value } = await Swal.fire({
                    title: 'Edit Post',
                    html: `<textarea id="ed-post-content" class="form-control" rows="5">${post.content || ''}</textarea>`,
                    showCancelButton: true,
                    preConfirm: () => document.getElementById('ed-post-content').value
                });
                if (value) {
                    await updateDoc(post.ref, { content: value, editedByAdmin: true });
                    await this.refreshAll();
                    Swal.fire('Updated', '', 'success');
                }
            },
            
            async deletePost(post) {
                if (confirm('Delete this post?')) {
                    await deleteDoc(post.ref);
                    await this.refreshAll();
                }
            },
            
            async viewDM(dm) {
                const msgsSnap = await getDocs(query(collection(db, COLLECTIONS.CONV_MESSAGES(dm.id)), orderBy('createdAt', 'asc')));
                const msgs = msgsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const msgHtml = msgs.map(m => `
                    <div class="mb-2 border-bottom pb-1">
                        <small class="text-muted">${this.getAuthorName(m.senderId)} (${formatDate(m.createdAt)}):</small>
                        <div>${m.content}</div>
                        <button class="btn btn-link btn-sm p-0 text-danger" onclick="window.deleteDMMessage('${dm.id}', '${m.id}')">Delete</button>
                    </div>
                `).join('');
                
                // Hack to handle delete from Swal
                window.deleteDMMessage = async (convId, msgId) => {
                    if(confirm('Delete message?')) {
                        await deleteDoc(doc(db, COLLECTIONS.CONV_MESSAGES(convId), msgId));
                        Swal.close();
                        this.viewDM(dm); // Refresh
                    }
                };

                Swal.fire({
                    title: 'Conversation',
                    html: `<div style="max-height: 400px; overflow-y: auto; text-align: left;">${msgHtml || 'No messages'}</div>`,
                    width: 600
                });
            },
            
            async deleteDM(id) {
                 if (confirm('Delete this conversation?')) {
                    await deleteDoc(doc(db, COLLECTIONS.CONVERSATIONS, id));
                    await this.refreshAll();
                }
            },

            async editUser(user) {
                const { value } = await Swal.fire({
                    title: 'Edit User',
                    html: `
                        <input id="ed-displayName" class="form-control mb-2" placeholder="Display Name" value="${user.displayName || ''}">
                        <input id="ed-handle" class="form-control mb-2" placeholder="Handle" value="${user.handle || ''}">
                        <input id="ed-email" class="form-control mb-2" placeholder="Email" value="${user.email || ''}">
                        <input id="ed-photoURL" class="form-control mb-2" placeholder="Photo URL" value="${user.photoURL || ''}">
                        <textarea id="ed-customCSS" class="form-control mb-2" placeholder="Custom CSS">${user.customCSS || ''}</textarea>
                        <div class="form-check text-start">
                            <input class="form-check-input" type="checkbox" id="ed-activity" ${user.activityTracking ? 'checked' : ''}>
                            <label class="form-check-label" for="ed-activity">Activity Tracking</label>
                        </div>
                    `,
                    width: 600,
                    showCancelButton: true,
                    preConfirm: () => ({
                        displayName: document.getElementById('ed-displayName').value,
                        handle: document.getElementById('ed-handle').value,
                        email: document.getElementById('ed-email').value,
                        photoURL: document.getElementById('ed-photoURL').value,
                        customCSS: document.getElementById('ed-customCSS').value,
                        activityTracking: document.getElementById('ed-activity').checked
                    })
                });
                if (value) {
                    await updateDoc(doc(db, COLLECTIONS.USER_PROFILES, user.id), value);
                    await this.refreshAll();
                    Swal.fire('Updated', '', 'success');
                }
            }
        }));
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
</body>
</html>